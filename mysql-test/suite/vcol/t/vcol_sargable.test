--source include/have_sequence.inc
--source include/not_embedded.inc

--echo # Check various condition types
create table t1 (a int, vcol1 int as (a+1), index(vcol1));
insert into t1 (a) select seq from seq_1_to_100;
explain select * from t1 where a+1=2;
--echo # Try renaming the table
explain select * from t1 as TBL where TBL.a+1=2;
explain select * from t1 where a+1<=2;
explain select * from t1 where a+1<2;
explain select * from t1 where a+1>100;
explain select * from t1 where a+1>=100;
explain select * from t1 where a+1 between 10 and 12;
explain select * from t1 where (a+1) IS NULL;
explain select * from t1 force index(vcol1) where (a+1) IS NOT NULL;
explain select * from t1 where (a+1) in (1,2,3,4);

--echo # Check UPDATE/DELETE:
explain delete from t1 where a+1=2;
explain update t1 set a=a+1 where a+1=2;

--echo # Try merged VIEWs:
create view v1 as select * from t1;
explain select * from v1 where a+1=2;
create view v2 as select a as A_COL from t1;
explain select * from v2 where A_COL+1=2;
drop view v1;
drop view v2;

set names utf8mb4;
select @@collation_connection;
--echo # Check VARCHAR
create table t2 (
  a varchar(32),
  vcol1 varchar(32) as (concat('hello-',a)),
  index(vcol1)
);
insert into t2 (a) select seq from seq_1_to_100;
select collation('aaa'), collation(vcol1) from t2 limit 1;
# Also check optimizer trace coverage
set @tmp_trace=@@optimizer_trace;
set optimizer_trace=1;
--echo # This won't work:
explain select * from t2 where concat('bye-', a)='hello-5';
--echo # This will work:
explain select * from t2 where concat('hello-', a)='hello-5';
--disable_view_protocol
select
  json_detailed(json_extract(trace, '$**.virtual_column_substitution'))
from
  information_schema.optimizer_trace;
--enable_view_protocol

--echo # Try also ON expressions
explain
select *
from t1 left join t2 on concat('hello-', t2.a)='hello-5'
where
  t1.a+1=2;
--disable_view_protocol
select
  json_detailed(json_extract(trace, '$**.virtual_column_substitution'))
from
  information_schema.optimizer_trace;
--enable_view_protocol

create table t3 (a int);
insert into t3 values (1),(2);
explain
select *
from
  t3 left join
    (t1 join t2 on concat('hello-', t2.a)='hello-5' and t1.a+1=2)
  on t3.a<3;
--disable_view_protocol
select
  json_detailed(json_extract(trace, '$**.virtual_column_substitution'))
from
  information_schema.optimizer_trace;
--enable_view_protocol

drop table t1,t2,t3;


set optimizer_trace=@tmp_trace;

--echo #
--echo # Implicit type/charset conversions
--echo #
create table t3 (
  a varchar(32) collate utf8mb4_general_ci,
  vcol1 int as (concat('100',a)),
  vcol2 varchar(32) collate utf8mb4_unicode_ci as (concat('hello-',a)),
  index(vcol1),
  index(vcol2)
);
insert into t3 (a) select seq from seq_1_to_100;

--echo # Type conversion
explain select * from t3 where concat('100', a)=10010;

--echo # Character set change
explain select * from t3 where concat('hello-', a)='abcd';
drop table t3;

--echo # Try JSON_EXTRACT
create table t1 (a int, js1 blob);
insert into t1
select seq, concat('{"size":', seq, ', "color":"hue', seq ,'"}') from seq_1_to_100;
select * from t1 limit 3;

alter table t1 add size1 int as (cast(json_extract(js1, '$.size') as int));
alter table t1 add index(size1);
explain select * from t1 where cast(json_extract(js1,'$.size') as int)=5 ;

#
# JSON_UNQUOTE() returns utf8mb3_unicode_ci, even if JSON_VALID() and other
# functions seem to accept utf8mb4 characters (This is a bug, MDEV-35496)
#
# Without COLLATE clause, the default is utf8mb4_uca1400_ai_ci.
#
alter table t1 add
  color varchar(100) COLLATE utf8mb3_general_ci
    as (json_unquote(json_extract(js1, '$.color')));
alter table t1 add index(color);

select * from t1 limit 3;

--echo # Index is used:
explain select * from t1 where json_unquote(json_extract(js1, '$.color'))='hue5';
explain select * from t1 where json_unquote(json_extract(js1, '$.color')) IS NULL;
explain select * from t1 force index(color)
where json_unquote(json_extract(js1, '$.color')) IS NOT NULL;

alter table t1 drop column color;
alter table t1 add
  color2 varchar(100)
    as (json_unquote(json_extract(js1, '$.color')));
alter table t1 add index(color2);
--echo # Index is not used due to collation mismatch:
explain select * from t1 where json_unquote(json_extract(js1, '$.color'))='hue5';

drop table t1;

